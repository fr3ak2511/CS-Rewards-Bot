name: Hourly Rewards Claimer

on:
  schedule:
    - cron: '0 * * * *'  # Keep as-is (no timing change needed)
  
  workflow_dispatch:

concurrency:
  group: rewards-claimer
  cancel-in-progress: true

jobs:
  run-claimer:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install Dependencies
        run: pip install -r requirements.txt
      
      - name: Run Master Claimer
        env:
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
        run: python master_claimer.py
      
      - name: Upload Debug Artifacts
        if: failure()  # Changed from 'always()' to 'failure()'
        uses: actions/upload-artifact@v4
        with:
          name: debug-data-${{ github.run_id }}
          path: |
            *.png
            *.html
          retention-days: 1
          if-no-files-found: ignore
      
      # NEW: This is the critical addition for v2.3
      - name: Commit Store Claims Log
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add store_claims_log.csv || true
          git diff --quiet && git diff --staged --quiet || git commit -m "Update store claims log [skip ci]"
          git push || true
